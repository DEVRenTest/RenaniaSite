<modification>

	<id>Review system</id>
	<version>1.0.0</version>
	<vqmver>2.1.5</vqmver>
	<author>Nicsoft Norbi</author>


	<file path="admin/view/template/common/" name="header.tpl">
		<operation error="skip">
			<search position="before"><![CDATA[<li id="help"><a class="top"><?php echo $text_help; ?></a>]]></search>
			<add><![CDATA[
			<!-- nicsoft_review.xml >> -->
			<li id="help"><a class="top"><?php echo "Comentarii"; ?></a>
				<ul>
					<li id="help"><a href="<?php echo $review; ?>"><?php echo "Lista Comentariilor"; ?></a></li>
					<li id="help"><a href="<?php echo $review_settings; ?>"><?php echo "Setări"; ?></a></li>
				</ul>
			</li>
			<!-- nicsoft_review.xml << -->
			]]></add>
		</operation>
		
		<operation error="skip">
			<search position="replace"><![CDATA[<li><a href="<?php echo $review; ?>"><?php echo $text_review; ?></a></li>]]></search>
			<add><![CDATA[
			<!-- nicsoft_review.xml >> -->
			<!-- nicsoft_review.xml << -->
			]]></add>
		</operation>
	</file>	
	
	<file path="admin/controller/common/" name="header.php">
		<operation error="skip">
			<search position="replace"><![CDATA[$this->data['review'] = $this->url->link('catalog/review', 'token=' . $this->session->data['token'], 'SSL');]]></search>
			<add><![CDATA[
/* nicsoft_review.xml >> */
			        $this->data['review'] = $this->url->link('catalog/review_ns', 'token=' . $this->session->data['token'], 'SSL');
			        $this->data['review_settings'] = $this->url->link('catalog/review_ns/editReviewSettings', 'token=' . $this->session->data['token'], 'SSL');
/* nicsoft_review.xml << */		
            ]]></add>
		</operation>
	</file>
	
	<file path="catalog/controller/product/" name="product.php">
		<operation error="skip">
			<search position="after"><![CDATA[$this->data['review_status'] = $this->config->get('config_review_status');]]></search>
			<add><![CDATA[
/* nicsoft_review.xml >> */
			if (!$this->customer->isLogged())
				$this->data['review_write'] = 1;
			else
				$this->data['review_write'] = 0;
			
			$this->data['logged_in'] = $this->customer->isLogged();
/* nicsoft_review.xml << */		
            ]]></add>
		</operation>
		
		<operation error="skip">
			<search position="after"><![CDATA[$this->data['reviews'][] = array(]]></search>
			<add><![CDATA[
/* nicsoft_review.xml >> */
        		'bought'     => $result['bought'],
        		'title'     => $result['title'],   
/* nicsoft_review.xml << */		
            ]]></add>
		</operation>
		<operation error="skip">
			<search position="before"><![CDATA[if ((utf8_strlen($this->request->post['name']) < 3) || (utf8_strlen($this->request->post['name']) > 25)) {]]></search>
			<add><![CDATA[
/* nicsoft_review.xml >> 			
            ]]></add>
		</operation>
		<operation error="skip">
			<search position="before"><![CDATA[if (!isset($json['error'])) {]]></search>
			<add><![CDATA[
 nicsoft_review.xml << */				
            ]]></add>
		</operation>
		<operation error="skip">
			<search position="after"><![CDATA[$this->data['reviews'] = sprintf($this->language->get('text_reviews'), (int)$product_info['reviews']);]]></search>
			<add><![CDATA[
/* nicsoft_review.xml >> */
			$this->data['nr_reviews'] = (int)$product_info['reviews'];	
/* nicsoft_review.xml << */			
            ]]></add>
		</operation>
		
	</file>
	
	<file path="catalog/view/theme/journal2/template/product/" name="product.tpl">
		<operation error="skip">
			<search position="after"><![CDATA[<div id="review"><?php echo $this->journal2->settings->get('product_reviews'); ?></div>]]></search>
			<add><![CDATA[
<!-- nicsoft_review.xml >> -->
				<?php if ($logged_in) { ?>
		<div id="rev_write_placeholder"><div>+</div> Adauga comentariu nou</div>
		<div id="rev_write">
			<h2 id="review-title"><?php echo $text_write; ?></h2>
			<b><?php echo "Titlu"; ?></b><br />
			<input type="text" name="title" value="" />
			<br />
			<br />
			<b><?php echo $entry_review; ?></b>
			<textarea name="text" cols="40" rows="8"></textarea>
			<span><?php echo $text_note; ?></span><br />
			<br />
			<b><?php echo $entry_rating; ?></b> <span><?php echo $entry_bad; ?></span>&nbsp;
			<input type="radio" name="rating" value="1" />
			&nbsp;
			<input type="radio" name="rating" value="2" />
			&nbsp;
			<input type="radio" name="rating" value="3" />
			&nbsp;
			<input type="radio" name="rating" value="4" />
			&nbsp;
			<input type="radio" name="rating" value="5" />
			&nbsp;<span><?php echo $entry_good; ?></span><br />
			<br />
			<div class="buttons">
			  <div class="right"><a id="button-review" class="button"><?php echo "Adaugare"; ?></a></div>
			  <div class="right"><a id="rev_write_cancel" class="button"><?php echo "Anulare"; ?></a></div>
			</div>
		</div>
<script>
jQuery(document).ready(function($) {
	$('#rev_write_placeholder').click(function () {
		$('#rev_write_placeholder').hide();
		$('#rev_write').slideToggle('slow');
	});
	$('#rev_write_cancel').click(function () {
		$('#rev_write').slideToggle('slow');
		$('#rev_write_placeholder').show();
		
		$('input[title=\'title\']').val('');
		$('textarea[name=\'text\']').val('');
		$('input[name=\'rating\']:checked').attr('checked', '');
		$('input[name=\'captcha\']').val('');
	});
});
</script>		
		<?php } ?>
  </div>
  <?php } ?>	
 <?php if(true==false){ ?>	  
<!--
	
            ]]></add>
		</operation>
		
		<operation error="skip">
			<search position="replace"><![CDATA[
			data: 'name=' + encodeURIComponent($('input[name=\'name\']').val()) + '&text=' + encodeURIComponent($('textarea[name=\'text\']').val()) + '&rating=' + encodeURIComponent($('input[name=\'rating\']:checked').val() ? $('input[name=\'rating\']:checked').val() : '') + '&captcha=' + encodeURIComponent($('input[name=\'captcha\']').val()),
		]]></search>
			<add><![CDATA[
/* nicsoft_review.xml >> */	
			data: 'title=' + encodeURIComponent($('input[name=\'title\']').val()) + '&text=' + encodeURIComponent($('textarea[name=\'text\']').val()) + '&rating=' + encodeURIComponent($('input[name=\'rating\']:checked').val() ? $('input[name=\'rating\']:checked').val() : '') + '&captcha=' + encodeURIComponent($('input[name=\'captcha\']').val()),
		
/* nicsoft_review.xml << */		
            ]]></add>
		</operation>
		<operation error="skip">
			<search position="replace"><![CDATA[		
			<div><img width="83" height="15" src="catalog/view/theme/default/image/stars-<?php echo $rating; ?>.png" alt="<?php echo $reviews; ?>" />&nbsp;&nbsp;<a onclick="$('a[href=\'#tab-review\']').trigger('click');"><?php echo $reviews; ?></a>&nbsp;&nbsp;&bull;&nbsp;&nbsp;<a onclick="$('a[href=\'#tab-review\']').trigger('click');"><?php echo $text_write; ?></a></div>]]></search>
			<add><![CDATA[
<!-- nicsoft_review.xml >> -->	
			<div><img width="83" height="15" src="catalog/view/theme/default/image/stars-<?php echo $rating; ?>.png" alt="<?php echo $reviews; ?>" />&nbsp;&nbsp;<a onclick="$('a[href=\'#tab-review\']').trigger('click');"><?php echo $nr_reviews." review-uri";//$reviews; ?></a></div>
<!-- nicsoft_review.xml << -->		
            ]]></add>
		</operation>
		
		<operation error="skip">
			<search position="replace"><![CDATA[
			$('input[name=\'name\']').val('');
			]]></search>
			<add><![CDATA[
/* nicsoft_review.xml >> */	
			$('input[name=\'title\']').val('');
/* nicsoft_review.xml << */		
            ]]></add>
		</operation>
		
		<operation error="skip">
			<search position="before"><![CDATA[
			$('#button-review').bind('click', function() {
			]]></search>
			<add><![CDATA[
/* nicsoft_review.xml >> */	
			if($('#button-review').length > 0)
/* nicsoft_review.xml << */		
            ]]></add>
		</operation>
		
	</file>
	
	<file path="catalog/view/theme/journal2/template/product/" name="category.tpl">
		<operation error="skip">
			<search position="replace"><![CDATA[<div class="rating"><img width="83" height="15" src="<?php echo Journal2Utils::staticAsset("catalog/view/theme/default/image/stars-{$product['rating']}.png"); ?>" alt="<?php echo $product['reviews']; ?>" /></div>]]></search>
			<add><![CDATA[
<!-- nicsoft_review.xml >> -->
			<div class="rating"><img width="83" height="15" src="<?php echo Journal2Utils::staticAsset("catalog/view/theme/default/image/stars-{$product['rating']}.png"); ?>" /> <a href="<?php echo $product['href']; ?>#tab-review"><div class="nr_rew">(<?php echo $product['reviews']; ?> review-uri)</div></a></div>
<!-- nicsoft_review.xml << -->			
			]]></add>
		</operation>
		
	</file>
	
	<file path="catalog/controller/product/" name="category.php">
		<operation error="skip">
			<search position="replace"><![CDATA['reviews' => sprintf( $this->language->get( 'text_reviews' ), ( int ) $result['reviews'] ),]]></search>
			<add><![CDATA[
/* nicsoft_review.xml >> */
			'reviews' => $result['reviews'] ,
/* nicsoft_review.xml << */
			]]></add>
		</operation>
		
	</file>
	

	<file path="catalog/model/catalog/" name="review.php">
			<operation error="skip">
				<search position="replace"><![CDATA[$this->db->query("INSERT INTO " . DB_PREFIX . "review SET author = '" . $this->db->escape($data['name']) . "', customer_id = '" . (int)$this->customer->getId() . "', product_id = '" . (int)$product_id . "', text = '" . $this->db->escape($data['text']) . "', rating = '" . (int)$data['rating'] . "', date_added = NOW()");]]></search>
				<add><![CDATA[
	/* nicsoft_review.xml >> */
			//get customer ip	
			$ipaddress = '';
    if (isset($_SERVER['HTTP_CLIENT_IP']))
        $ipaddress = $_SERVER['HTTP_CLIENT_IP'];
    else if(isset($_SERVER['HTTP_X_FORWARDED_FOR']))
        $ipaddress = $_SERVER['HTTP_X_FORWARDED_FOR'];
    else if(isset($_SERVER['HTTP_X_FORWARDED']))
        $ipaddress = $_SERVER['HTTP_X_FORWARDED'];
    else if(isset($_SERVER['HTTP_FORWARDED_FOR']))
        $ipaddress = $_SERVER['HTTP_FORWARDED_FOR'];
    else if(isset($_SERVER['HTTP_FORWARDED']))
        $ipaddress = $_SERVER['HTTP_FORWARDED'];
    else if(isset($_SERVER['REMOTE_ADDR']))
        $ipaddress = $_SERVER['REMOTE_ADDR'];
    else
        $ipaddress = 'UNKNOWN';
	
	//get customer name
	    $customername_query=$this->db->query("Select CONCAT(firstname,' ',middlename,' ',lastname) as name FROM " . DB_PREFIX . "customer WHERE customer_id=".(int)$this->customer->getId()." LIMIT 1");
	//check if customer bought curent product
		$bought=0;
		$cutomerbought_query=$this->db->query("Select COUNT(op.product_id) as count FROM " . DB_PREFIX . "order_product op LEFT JOIN " . DB_PREFIX . "order o ON op.order_id=o.order_id 
									WHERE o.customer_id='".(int)$this->customer->getId()."' AND op.product_id=".$product_id);
		if( !empty($cutomerbought_query) AND $cutomerbought_query->row['count'] > 0 ){
			$bought=1;
		}
		//add review to databse
		$this->db->query("INSERT INTO " . DB_PREFIX . "review SET 
			author = '" . $customername_query->row['name'] . "', 
			customer_id = '" . (int)$this->customer->getId() . "', 
			product_id = '" . (int)$product_id . "', 
			text = '" . $this->db->escape($data['text']) . "', 
			title = '" . $this->db->escape($data['title']) . "', 
			rating = '" . (int)$data['rating'] . "', 
			date_added = NOW(),
			ip='" . $ipaddress . "',
			bought=" . $bought
		);
		
		
		
		if ($this->config->get('review_config_emails')) {
		
			$this->load->model('catalog/product');
			$product = $this->model_catalog_product->getProduct($product_id );
			// HTML Mail
			$template = new Template();
			
			$template->data['title'] = "Opinie produs";
			
			$template->data['text_customer'] 	= "Nume";			$template->data['detail_customer'] 	= $customername_query->row['name'];
			$template->data['text_product'] 	= "Produs";			$template->data['detail_product'] 	= $product['name'];
			$template->data['text_rating'] 		= "Rating";			$template->data['detail_rating'] 	=(int)$data['rating'] ;
			$template->data['text_title'] 		= "Titlu";			$template->data['detail_title'] 	= $data['title'] ;
			$template->data['text_opinie'] 		= "Opinie";			$template->data['detail_opinie'] 	= $data['text'] ;
			
			$template->data['logo'] = $this->config->get('config_url') . 'image/' . $this->config->get('config_logo');	
			$template->data['store_url'] = $this->config->get('config_url');	
			$template->data['store_name'] = $this->config->get('config_name');	
			
			$subject="Opinie produs";
			$text="";
			if($this->config->get('config_name'))
				$store_name= $this->config->get('config_name');
			else
				$store_name="Undefindend Store Name";
			if (file_exists(DIR_TEMPLATE . $this->config->get('config_template') . '/template/mail/review_ns.tpl')) {
				$html = $template->fetch($this->config->get('config_template') . '/template/mail/review_ns.tpl');
			} else {
				$html = $template->fetch('default/template/mail/review_ns.tpl');
			}
						
			$mail = new Mail(); 
			$mail->protocol = $this->config->get('config_mail_protocol');
			$mail->parameter = $this->config->get('config_mail_parameter');
			$mail->hostname = $this->config->get('config_smtp_host');
			$mail->username = $this->config->get('config_smtp_username');
			$mail->password = $this->config->get('config_smtp_password');
			$mail->port = $this->config->get('config_smtp_port');
			$mail->timeout = $this->config->get('config_smtp_timeout');
			//$mail->setTo($this->config->get('config_email'));
			$mail->setFrom($this->config->get('config_email'));
			//$mail->setSender($this->config->get('config_store'));
			$mail->setSender($store_name);
			$mail->setSubject(html_entity_decode($subject, ENT_QUOTES, 'UTF-8'));
			$mail->setHtml($html);
			$mail->setText(html_entity_decode($text, ENT_QUOTES, 'UTF-8'));
			//$mail->send();
				
			// Send to additional alert emails
			$emails = explode(',', $this->config->get('review_config_emails'));
				
			foreach ($emails as $email) {
				if ($email && preg_match('/^[^\@]+@.*\.[a-z]{2,6}$/i', $email)) {
						$mail->setTo($email);
						$mail->send();
				}
			}				
		}
	/* nicsoft_review.xml << */
				]]></add>
			</operation>
			<operation error="skip">
				<search position="replace"><![CDATA[$query = $this->db->query("SELECT r.review_id, r.author, r.rating, r.text, p.product_id, pd.name, p.price, p.image, r.date_added FROM " . DB_PREFIX . "review r LEFT JOIN " . DB_PREFIX . "product p ON (r.product_id = p.product_id) LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) WHERE p.product_id = '" . (int)$product_id . "' AND p.date_available <= NOW() AND p.status = '1' AND r.status = '1' AND pd.language_id = '" . (int)$this->config->get('config_language_id') . "' ORDER BY r.date_added DESC LIMIT " . (int)$start . "," . (int)$limit);]]></search>
				<add><![CDATA[
	/* nicsoft_review.xml >> */
				$query = $this->db->query("SELECT r.review_id,r.title, r.author, r.rating, r.text,r.bought, p.product_id, pd.name, p.price, p.image, r.date_added FROM " . DB_PREFIX . "review r LEFT JOIN " . DB_PREFIX . "product p ON (r.product_id = p.product_id) LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) WHERE p.product_id = '" . (int)$product_id . "' AND p.date_available <= NOW() AND p.status = '1' AND r.status = '1' AND pd.language_id = '" . (int)$this->config->get('config_language_id') . "' ORDER BY r.date_added DESC LIMIT " . (int)$start . "," . (int)$limit);
	/* nicsoft_review.xml << */
				]]></add>
			</operation>
			
		</file>

		<file path="catalog/view/theme/journal2/template/product/" name="review.tpl">
			<operation error="skip">
				<search position="replace"><![CDATA[<div class="author"><b itemprop="author"><?php echo $review['author']; ?></b> <?php echo $text_on; ?> <span itemprop="datePublished"><?php echo $review['date_added']; ?></span></div>]]></search>
				<add><![CDATA[
	<!-- nicsoft_review.xml >> -->
		<!-- row deleted -->
	<!-- nicsoft_review.xml << -->
				]]></add>
			</operation>
			
			<operation error="skip">
				<search position="replace"><![CDATA[<div class="rating" itemprop="reviewRating" itemscope itemtype="http://schema.org/Rating"><img width="83" height="15" src="catalog/view/theme/default/image/stars-<?php echo $review['rating'] . '.png'; ?>" alt="<?php echo $review['rating']; ?>" title="<?php echo $review['rating']; ?> "/><meta itemprop="worstRating" content="1"> ( <span itemprop="ratingValue"><?php echo $review['rating']; ?></span> / <span itemprop="bestRating">5</span> )</div>]]></search>
				<add><![CDATA[
	<!-- nicsoft_review.xml >> -->
		<!-- row deleted -->
	<!-- nicsoft_review.xml << -->
				]]></add>
			</operation>

			<operation error="skip">
				<search position="replace"><![CDATA[<div class="text" itemprop="description"><?php echo $review['text']; ?></div>]]></search>
				<add><![CDATA[
	<!-- nicsoft_review.xml >> -->
		<table>
<tr>
<td style="width:150px;">
  <div class="author">Review scris de <br><b itemprop="author"><?php echo $review['author']; ?></b><br> 
		<span itemprop="datePublished">
		<?php 
			$date1 = new DateTime();
			$date2 = new DateTime($review['date_added']);
			$interval = $date1->diff($date2);
			echo "acum " . $interval->days . " zile ";
			//echo $review['date_added']; ?>
		</span>
		<?php if(isset($review['bought'])) if($review['bought']) { ?>
		<div class="bought">
			<div class="verified">✓</div> Achizitie verificata
		</div>
		 <?php } ?>
	</div>
 </td>
 <td style="text-aligh:left;">
  <div class="text" itemprop="description">
  <div class="review_title"><?php if(isset($review['title'])) echo $review['title']; ?></div>
  <div class="rating" itemprop="reviewRating" itemscope itemtype="http://schema.org/Rating"><img width="83" height="15" src="catalog/view/theme/default/image/stars-<?php echo $review['rating'] . '.png'; ?>" alt="<?php echo $review['rating']; ?>" title="<?php echo $review['rating']; ?> "/><meta itemprop="worstRating" content="1"></div>
  <br>
  <?php echo $review['text']; ?>
  
  </div>
  </td>
  </tr>
  </table>
	<!-- nicsoft_review.xml << -->
				]]></add>
			</operation>
		</file>
	

</modification>

